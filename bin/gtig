#!/usr/bin/env python3
import subprocess
import sys
import re

def strip_ansi(text):
    ansi_escape = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')
    return ansi_escape.sub('', text)

def get_visible_length(text):
    return len(strip_ansi(text))

def main():
    # Construct git log command
    # We use tabs as delimiters.
    # Format: Graph <TAB> Date <TAB> Author <TAB> Refs Subject

    cmd = [
        'git', 'log', '--graph', '--color=always',
        '--date=format:%Y-%m-%d %H:%M',
        '--pretty=format:%x09%C(cyan)%cd%Creset%x09%C(blue)%an%Creset%x09%C(auto)%d%Creset %s'
    ]

    # Add user args or default to --all -n 20
    args = sys.argv[1:]
    if not args:
        args = ['--all', '-n', '20']

    cmd.extend(args)

    try:
        process = subprocess.Popen(cmd, stdout=subprocess.PIPE, text=True)
    except Exception as e:
        print(f"Error running git log: {e}", file=sys.stderr)
        return

    lines = []
    # Read all lines to calculate column widths
    try:
        for line in process.stdout:
            lines.append(line.rstrip())
    except Exception as e:
         print(f"Error reading git log output: {e}", file=sys.stderr)

    process.wait()
    if process.returncode != 0:
        # If git log failed (e.g. invalid args), exit.
        # But we might have some output?
        if not lines:
            sys.exit(process.returncode)

    parsed = []
    max_author_len = 0

    for line in lines:
        parts = line.split('\t')

        if len(parts) >= 4:
            graph = parts[0]
            date = parts[1]
            author = parts[2]
            # Join the rest in case subject contains tabs
            subject = "\t".join(parts[3:])

            a_len = get_visible_length(author)
            if a_len > max_author_len:
                max_author_len = a_len

            parsed.append({
                'type': 'commit',
                'graph': graph,
                'date': date,
                'author': author,
                'subject': subject
            })
        else:
            parsed.append({
                'type': 'graph',
                'text': line
            })

    # Fixed width for date: "YYYY-MM-DD HH:MM" is 16 chars.
    date_width = 16

    for item in parsed:
        if item['type'] == 'commit':
            d = item['date']
            a = item['author']
            g = item['graph']
            s = item['subject']

            # Pad author
            visible_a = get_visible_length(a)
            padding = " " * (max_author_len - visible_a)

            print(f"{d} {a}{padding} {g}{s}")

        else:
            # Graph only line.
            # Indent: Date + space + Max Author + space
            indent = " " * (date_width + 1 + max_author_len + 1)
            print(f"{indent}{item['text']}")

if __name__ == "__main__":
    main()
