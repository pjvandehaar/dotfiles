#!/usr/bin/env python3

## setup: pip3 install pillow

from PIL import Image, ImageDraw, ImageFont, ImageGrab
import itertools, time, subprocess, re, urllib.request, io, sys, pyperclip


def download_img(url):
    headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}
    request = urllib.request.Request(url, headers=headers)
    with urllib.request.urlopen(request) as resp:
        return Image.open(io.BytesIO(resp.read()))
URL_regex = re.compile(
    r'^(?:http|ftp)s?://' # http:// or https://
    r'(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+(?:[A-Z]{2,6}\.?|[A-Z0-9-]{2,}\.?)|' #domain...
    r'localhost|' #localhost...
    r'\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})' # ...or ip
    r'(?::\d+)?' # optional port
    r'(?:/?|[/?]\S+)$', re.IGNORECASE)
IMG_regex = re.compile(r'\.(?:png|gif|jpg|jpeg|tif|bmp|webp)$', re.IGNORECASE)
def get_img():
    if len(sys.argv)>1 and sys.argv[1]:
        if URL_regex.match(sys.argv[1]) and IMG_regex.search(sys.argv[1]):
            return download_img(sys.argv[1])
        return Image.open(sys.argv[1])
    clipboard_contents = pyperclip.paste()
    if URL_regex.match(clipboard_contents) and IMG_regex.search(clipboard_contents):
        return download_img(clipboard_contents)
    try:
        subprocess.check_output(['pngpaste', '/tmp/image.png'], stderr=subprocess.DEVNULL)
        return Image.open('/tmp/image.png') # TODO: use BytesIO
    except subprocess.CalledProcessError: pass
    time.sleep(1) # give time to hide terminal
    return ImageGrab.grab()


def overlay_text(base, text):
    location = (0.1, 0.1)
    minisize = (base.size[0]//64, base.size[1]//64)
    txt = Image.new('RGBA', minisize, (255,255,255,255))
    fnt = ImageFont.load_default()
    d = ImageDraw.Draw(txt)
    d.text((minisize[0]*location[0], minisize[1]*location[1]), text, font=fnt, fill=(0,0,0,255))
    txt = txt.resize((minisize[0]*4, minisize[1]*4))
    base.paste(txt)

screenshot = get_img()
bands = screenshot.split()

def make_image(channel_order):
    img = Image.merge('RGBA', [bands[i] for i in channel_order]+[bands[3]])
    overlay_text(img, ' '.join('RGB'[i] for i in channel_order))
    return img

orders, duration = [(1,2,0), (2,0,1)], 1000
#orders, duration = [(0,1,2), (0,2,1), (1,2,0), (1,0,2), (2,0,1), (2,1,0)], 500
#orders, duration = itertools.permutations([0,1,2]), 200
#orders, duration = list(itertools.product(*[[0,1,2]]*3), 200
images = [make_image(order) for order in orders]
#images.append(images[0].point(lambda x:0)) # all black

# images[0].save('/tmp/x.gif', save_all=True, append_images=images[1:], duration=duration)
# subprocess.call('qlmanage -p /tmp/x.gif'.split(), stderr=subprocess.DEVNULL, stdout=subprocess.DEVNULL)

for img in images: img.show()
